<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Docker and Kubernetes | Neojal Github Site</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="Docker and Kubernetes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Quickstart guide" />
<meta property="og:description" content="Quickstart guide" />
<link rel="canonical" href="/infrastructure/docker-kubernetes.html" />
<meta property="og:url" content="/infrastructure/docker-kubernetes.html" />
<meta property="og:site_name" content="Neojal Github Site" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-21T18:18:13-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Docker and Kubernetes" />
<script type="application/ld+json">
{"@type":"BlogPosting","description":"Quickstart guide","headline":"Docker and Kubernetes","dateModified":"2021-04-21T18:18:13-05:00","datePublished":"2021-04-21T18:18:13-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"/infrastructure/docker-kubernetes.html"},"url":"/infrastructure/docker-kubernetes.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Neojal Github Site" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Neojal Github Site</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Docker and Kubernetes</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-04-21T18:18:13-05:00" itemprop="datePublished">Apr 21, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="learning-docker">Learning Docker</h1>

<h2 id="introduction">Introduction</h2>

<p>Docker mission: Build, Ship &amp; Run distributed applications.</p>

<ul>
  <li>Build: Docker Image.</li>
  <li>Ship: Docker Hub (or another repository)</li>
  <li>Run: Docker Container.</li>
</ul>

<p>Avoid single point of failure by running multiple containers.</p>

<h3 id="what-is-a-container-general">What is a Container (General)?</h3>

<p>A collection of software processes unified by one namespace,
with access to an operating system kernel that shares with other
containers and little to no access between containers.</p>

<h3 id="docker-instance">Docker Instance</h3>

<p>A runtime of a Docker image contains three things:</p>

<ol>
  <li>A Docker image.</li>
  <li>An Execution environment.</li>
  <li>A standard set of instructions</li>
</ol>

<h3 id="docker-engine">Docker Engine</h3>

<p>Comprised of the runtime and packaging tool; <strong>must</strong> be installed in
the hosts that run Docker.</p>

<h3 id="difference-between-vm-and-a-container">Difference between VM and a Container:</h3>

<h4 id="vm">VM:</h4>

<ul>
  <li>The entire guest operating system to interact with the apps.</li>
</ul>

<h4 id="container">Container:</h4>

<ul>
  <li>Shares the host kernel with other containers.</li>
  <li>Needs Docker Engine installed on the Host.</li>
  <li>Run as isolated processes on the host OS.</li>
  <li>Includes the application and all of its dependencies.</li>
</ul>

<h3 id="container-benefits-for-developers">Container benefits for Developers:</h3>

<p>Apps are:</p>

<ul>
  <li>portable</li>
  <li>packaged in a standard way</li>
</ul>

<p>Deployment is:</p>

<ul>
  <li>Easy</li>
  <li>Repeatable</li>
  <li>Automated testing, packaging, and integrations</li>
  <li>Support new microservice architectures</li>
  <li>Alleviate platform compatibility issues</li>
</ul>

<h3 id="benefits-for-devops">Benefits for DevOps:</h3>

<ul>
  <li>Reliable deployments: improve speed and frequency of releases.</li>
  <li>Consistent application lifecycle: configure once and run multiple times.</li>
  <li>Improves communication between developers and devops.</li>
</ul>

<h1 id="learning-kubernetes">Learning Kubernetes</h1>
<p>Container orchestrator: manages containers in a host or across your whole infrastructure.</p>

<h2 id="k8s-introduction">K8S introduction</h2>

<p><strong>Container orchestrator features</strong>:</p>

<ul>
  <li>Provision hosts</li>
  <li>Instantiate containers on a host</li>
  <li>Restart failing containers</li>
  <li>Expose containers as service outside the cluster</li>
  <li>Scale the cluster up and down</li>
</ul>

<p>Kubernetes is a platform to schedule and run containers on:</p>

<ul>
  <li>clusters of VM</li>
  <li>bare metal</li>
  <li>private data center</li>
  <li>public cloud</li>
</ul>

<h3 id="kubernetes-features">Kubernetes Features</h3>

<p><strong>Multi-Host Container Scheduling</strong>:</p>

<ul>
  <li>Done by the <em>kube-scheduler</em></li>
  <li>Assigns pods to nodes at runtime</li>
  <li>Checks resources, quality of service and user specifications before scheduling</li>
</ul>

<p><strong>Availability</strong>:</p>

<ul>
  <li>Kubernetes <em>master node</em> can be deployed in a highly available configuration</li>
  <li>Multi region deployments available</li>
</ul>

<p><strong>Scalability</strong>:</p>

<ul>
  <li>Registration: seamless working nodes register themselves with master node.</li>
  <li>Service discovery: automatic detection of services and endpoints via DNS or environment variables</li>
</ul>

<p><strong>Persistent Storage</strong></p>

<ul>
  <li>Useful and important feature when working with containers</li>
  <li>Pods can use persistent volumes to store data</li>
  <li>Data retained across pod restarts and crashes</li>
</ul>

<p><strong>Logging and Monitoring</strong>:</p>

<ul>
  <li>Application monitoring built in
    <ul>
      <li>TCP, HTTP, or container execution health check</li>
    </ul>
  </li>
  <li>Node health check
    <ul>
      <li>Failures monitored by node controller</li>
    </ul>
  </li>
  <li>Kubernetes status
    <ul>
      <li>can also be monitored via add-ons</li>
    </ul>
  </li>
</ul>

<p><strong>Secrets management</strong>:</p>

<ul>
  <li>Sensitive data is first-class citizen</li>
  <li>Mounted as data volumes or environment variables</li>
  <li>Specific to namespace</li>
</ul>

<h3 id="kubernetes-cluster-architecture">Kubernetes Cluster Architecture</h3>
<p><a href="https://kubernetes.io/docs/concepts/overview/components/">kubernetes.io - components</a></p>

<p><img src="/assets/k8s-architecture.png" alt="k8s-architecture" /></p>

<p><strong>Master Node</strong>:</p>

<ul>
  <li>API server</li>
  <li>Scheduler</li>
  <li>Controller Manager
    <ul>
      <li>node controller</li>
      <li>replication controller</li>
      <li>service account</li>
      <li>…</li>
    </ul>
  </li>
</ul>

<p><strong>etcd</strong>:</p>

<ul>
  <li>key/value store</li>
  <li>configuration/schedules storage</li>
</ul>

<p><strong>kubectl</strong>:</p>

<ul>
  <li><em>cli</em> to interact with the master node</li>
  <li>kubeconfig (config file)
    <ul>
      <li>auth info to access the API server</li>
    </ul>
  </li>
</ul>

<p><strong>Worker nodes</strong>:</p>

<ul>
  <li>is where our applications operate</li>
  <li><strong>kubelet</strong>: manages communication processes</li>
  <li><strong>kube proxy</strong>: network proxy and load balancer</li>
  <li><strong>docker</strong>: allows containers execution
    <ul>
      <li><strong>pod</strong>: is the smallest component that can be deployed in kubernetes and is made of one or more containers.
        <ul>
          <li><strong>containers</strong>: are stored in pods</li>
          <li>this group of containers share storage, IP address, namespace, etc.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Another view of a K8s cluster:</p>

<p><img src="/assets/k8s-cluster-view.png" alt="k8s-cluster-view" /></p>

<h3 id="nodes-and-pods">Nodes and Pods</h3>

<h4 id="nodes">Nodes</h4>

<ul>
  <li>A node is a worker machine in K8s.</li>
  <li>A node may be a VM or physical machine, depending on the cluster.</li>
</ul>

<p><strong>Node Requirements</strong>:</p>
<ul>
  <li>a Kubelet running</li>
  <li>container tooling like Docker</li>
  <li>a kube-proxy process running</li>
  <li>supervisord (process control system)</li>
</ul>

<p>In production, it’s recommended to have at least a 3 node cluster.</p>

<h4 id="pod">Pod</h4>

<p>Pods are the simplest deployable unit of computing that can be created 
and managed in Kubernetes.</p>

<p>A pod is a group of one or more containers with shared storage/network 
and a specification for how to run the containers.</p>

<p>The containers in a pod share the same IP address and port space, 
and can communicate between them with localhost.</p>

<p>Containers in a pod share a context.</p>

<p><strong>What’s in the pod?</strong></p>

<ul>
  <li>Your docker application container</li>
  <li>Storage resources</li>
  <li>Unique network IP</li>
  <li>Options that govern how the container(s) should run</li>
</ul>

<p><strong>Pods are</strong>:</p>

<ul>
  <li>Ephemeral, disposable</li>
  <li>Never self-heal and not restarted by the scheduler itself</li>
</ul>

<p><strong>Pod lifecycle</strong>:</p>

<ul>
  <li>Pending: Pod accepted by k8s, but no container running yet</li>
  <li>Running: Pod has been scheduled in a node.</li>
  <li>Succeeded (status 0): all containers in a pod are in execution.</li>
  <li>Failed (non 0 status): at least one container has failed.</li>
  <li>CrashLoopBackOff: kubernetes tries over and over to restart a pod.</li>
</ul>

<h3 id="controllers-deployments-replicasets-and-services">Controllers: Deployments, ReplicaSets, and Services</h3>

<p><strong>Benefits of Controllers</strong>:</p>

<ul>
  <li>App reliability</li>
  <li>Scaling</li>
  <li>Load balancing</li>
</ul>

<p><strong>Kinds of Controllers</strong>:</p>

<ul>
  <li>ReplicaSets</li>
  <li>Deployments</li>
  <li>DaemonSets</li>
  <li>Jobs</li>
  <li>Services</li>
</ul>

<p><strong>ReplicaSets</strong>: Ensures that a specified number of replicas 
for a pod are running at the same time.</p>

<p><strong>Deployments</strong>: A Deployment controller provides declarative updates
for pods and ReplicaSets. Use cases:</p>

<ul>
  <li>Pod management (Running a ReplicaSet)</li>
  <li>Scaling a ReplicaSet</li>
  <li>Pause (make changes) and Resume deployments</li>
  <li>Status, check for health of the pods</li>
</ul>

<p><strong>DaemonSets</strong>: ensure that all nodes run a copy of a specific pod.
As nodes are added or removed from the cluster, a DaemonSet will add 
or remove the required pods.</p>

<p><strong>Jobs</strong>: Supervisor process for pods carrying out batch jobs. Run individual
processes that run once and complete successfully. Run as a cronjob.</p>

<p><strong>Service</strong>: Allows the communication between one set of deployments with other.
Use a service to get pods in two deployments to talk to each other.</p>

<ul>
  <li>Internal: IP is only reachable within the cluster.</li>
  <li>External: endpoint available through node ip:port (NodePort).</li>
  <li>Load Balancer: Exposes application to the internet with a load balancer (cloud provider).</li>
</ul>

<h3 id="labels-selectors-and-namespaces">Labels, Selectors, and Namespaces</h3>
<p>These constructs allow us to annotate and organize our apps. Usually used with
kubectl.</p>

<p><strong>Labels</strong>: are key/value pairs that are attached to objects like pods,
services, and deployments. Labels are for users of Kubernetes to identify
attributes for objects.</p>

<p><code class="language-plaintext highlighter-rouge">"label":value"</code></p>

<p><strong>Selectors</strong>: Used to select components by <em>label</em> and/or <em>value</em>.</p>

<ul>
  <li>Equality-based selectors: =, !=</li>
  <li>Set-based selectors: IN, NOTIN, EXIST</li>
</ul>

<p><strong>Namespaces</strong>: allows to have multiple virtual clusters in the same physical cluster.</p>

<ul>
  <li>great for large enterprises</li>
  <li>allows teams to access resources, with accountability</li>
  <li>divide cluster resources between users</li>
  <li>
    <p>scope for names must be unique in each namespace</p>
  </li>
  <li>“Default” namespace created when you launch Kubernetes.</li>
  <li>Objects placed in “default” namespace at start.</li>
  <li>Newer applications install their resources in a different namespace.</li>
</ul>

<h3 id="kubelet-and-kube-proxy">Kubelet and kube-proxy</h3>

<h4 id="kubelet">Kubelet</h4>
<p>Is the “Kubernetes node agent” that runs on each node.</p>

<p>Kubelet roles:</p>

<ul>
  <li>Communicates with API server to see if pods have been assigned to nodes.</li>
  <li>Executes pod containers via a container engine</li>
  <li>Mounts and runs pod volumes and secrets</li>
  <li>Executes health checks to identify pod/node status</li>
</ul>

<p>The Kubelet works in terms of <strong>Podspec</strong>:</p>

<ul>
  <li>YAML file that describes a pod.</li>
</ul>

<p>The Kubelet takes a set of Podspecs provided by kube-apiserver and
ensures that containers described in those Podspecs are running and healthy.</p>

<p>Kubelet only manages containers that were created by the API server.</p>

<h4 id="kube-proxy-the-network-proxy">kube-proxy: the network proxy</h4>

<ul>
  <li>Works on all nodes</li>
  <li>Reflects services as defined on each node</li>
</ul>

<p>There are three modes of kube-proxy:</p>

<ol>
  <li>User space mode (the most common)</li>
  <li>Iptables mode</li>
  <li>Ipvs mode</li>
</ol>

<ul>
  <li>kube-proxy watches the API server for the addition and removal of services.</li>
  <li>connections to the node are then proxied to the corresponding node</li>
</ul>

<hr />

<h2 id="kubernetes-hello-world">Kubernetes Hello-World!</h2>

<h3 id="running-kubernetes-in-windows-10">Running Kubernetes in Windows 10</h3>

<p>To run Kubernetes locally in Windows 10, there are four general components required 
that I have detected:</p>

<ul>
  <li><strong>Virtualization technology</strong>:
    <ul>
      <li>WSL2 (Windows10, version 2004, build 19041 or higher). WSL2 uses Hyper-V architecture to enable virtualization.</li>
      <li>Hyper-V (Windows 10 pro)</li>
      <li>Virtual Machines: VirtualBox, VMware, etc.</li>
    </ul>
  </li>
  <li><strong>Container technology</strong>:
    <ul>
      <li><a href="https://www.docker.com/resources/what-container">Docker</a></li>
      <li><a href="https://containerjournal.com/topics/container-ecosystems/5-container-alternatives-to-docker/">Docker alternatives</a></li>
    </ul>
  </li>
  <li><strong>Kubernetes Client</strong>:
    <ul>
      <li><a href="https://kubernetes.io/docs/reference/kubectl/overview/">kubctl</a></li>
    </ul>
  </li>
  <li><strong>Kubernetes Server (cluster)</strong>:
    <ul>
      <li><a href="https://docs.docker.com/docker-for-windows/kubernetes/">Docker-Desktop</a></li>
      <li><a href="https://kubernetes.io/docs/setup/learning-environment/minikube/">Minikube</a></li>
      <li><a href="https://kind.sigs.k8s.io/">KinD</a></li>
      <li>Managed Kubernetes:
        <ul>
          <li><a href="https://aws.amazon.com/eks/">Amazon EKS</a></li>
          <li><a href="https://cloud.google.com/kubernetes-engine">Google GKE</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>So, as you can see, there are several alternatives to run Kubernetes locally in Windows.
There are some posts with different component stacks:</p>

<ul>
  <li><a href="https://kubernetes.io/blog/2020/05/21/wsl-docker-kubernetes-on-the-windows-desktop/">Docker-Desktop + WSL2 + KinD or Minikube</a></li>
  <li><a href="https://medium.com/containers-101/local-kubernetes-for-windows-minikube-vs-docker-desktop-25a1c6d3b766">Minikube vs Docker-Desktop</a></li>
</ul>

<h3 id="option-1-hyper-v-and-minikube">Option 1: Hyper-V and Minikube</h3>

<p>Windows 10 pro required because Hyper-V system is required.</p>

<ol>
  <li>
    <p>Install Docker-Desktop, then:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># docker --version</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install/Enable kubectl, then:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># kubectl version --client</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install Minikube, then:</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># minikube start</span>
</code></pre></div>    </div>
  </li>
  <li>On Windows: Hyper-V Manager:
    <ul>
      <li>Actions -&gt; Virtual Switch Manager</li>
      <li>New Virtual Network Switch -&gt; Internal -&gt; Create Virtual Switch
        <ul>
          <li>name: “minikube”</li>
          <li>select: “Internal Network”</li>
          <li>click OK.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>In Windows: Network and Sharing center:
    <ul>
      <li>Select the current Internet connection
        <ul>
          <li>Properties -&gt; Sharing tab</li>
          <li>Check “Allow other network users…”</li>
          <li>Select vEthernet (minikube)</li>
          <li>Keep checked “Allow other network users to control or…”</li>
          <li>click OK</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>Start Minikube with driver and switch parameters:</p>

    <pre><code class="language-cmd"> &gt; minikube start --vm-driver="hyperv" --hyperv-virtual-switch="minikube"
</code></pre>
  </li>
  <li>
    <p>Done! kubectl can now talk to Minikube cluster.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> &gt; kubectl get nodes
 NAME       STATUS   ROLES    AGE   VERSION
 minikube   Ready    master   19m   v1.18.3
</code></pre></div>    </div>
  </li>
  <li>
    <p>Windows Hyper-V manages Docker and Minikube VM:</p>

    <p><img src="/assets/k8s-win-hyperv.png" alt="k8s-hyperv" /></p>
  </li>
</ol>

<h3 id="option-2-wsl2-and-docker-desktop">Option 2: WSL2 and Docker-Desktop</h3>

<ol>
  <li>Enable WSL2 in Windows 10.</li>
  <li>Install Docker-Desktop.
    <ol>
      <li>Settings -&gt; Resources -&gt; WSL Integration: check Enable and check additional distros.</li>
      <li>Settings -&gt; Kubernetes: check Enable Kubernetes.</li>
    </ol>
  </li>
</ol>

<p>Now you can execute <code class="language-plaintext highlighter-rouge">docker</code> and <code class="language-plaintext highlighter-rouge">kubectl</code> commands in PowerShell, and
also in an installed distro only if <strong>additional distro</strong> was selected
(such as Ubuntu running in WSL).</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>docker <span class="nt">--version</span>
Docker version 19.03.8, build afacb8b7f0

<span class="nv">$ </span>kubectl version
Client Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"16+"</span>, GitVersion:<span class="s2">"v1.16.6-beta.0"</span>, GitCommit:<span class="s2">"e7f962ba86f4ce7033828210ca3556393c377bcc"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2020-01-15T08:26:26Z"</span>, GoVersion:<span class="s2">"go1.13.5"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>
Server Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"16+"</span>, GitVersion:<span class="s2">"v1.16.6-beta.0"</span>, GitCommit:<span class="s2">"e7f962ba86f4ce7033828210ca3556393c377bcc"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2020-01-15T08:18:29Z"</span>, GoVersion:<span class="s2">"go1.13.5"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>

<span class="nv">$ </span>kubectl get nodes
NAME             STATUS   ROLES    AGE   VERSION
docker-desktop   Ready    master   58m   v1.16.6-beta.0

<span class="nv">$ </span>kubectl cluster-info
Kubernetes master is running at https://kubernetes.docker.internal:6443
KubeDNS is running at https://kubernetes.docker.internal:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

<span class="nv">$ </span>kubectl describe node docker-desktop
Name:               docker-desktop
Roles:              master
Labels:             beta.kubernetes.io/arch<span class="o">=</span>amd64
</code></pre></div></div>

<p><strong>Kubernetes exercises</strong>: <a href="https://github.com/karthequian/kubernetes">github-karthequian-kubernetes</a></p>

<p><strong>**:
**</strong>:
<em>**</em>:</p>


  </div><a class="u-url" href="/infrastructure/docker-kubernetes.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

<!--
    <h2 class="footer-heading">Neojal Github Site</h2>
    <a class="footer-heading" rel="author" href="/">Neojal Github Site</a>
-->

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Neojal Github Site
            </li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/neojal"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">neojal</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Software Engineering, related topics and tools.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
